# @format

name: "Microlocs: Automation"

on:
  workflow_dispatch:
  schedule:
    # Runs on Fridays at 9:00 AM IST (03:30 AM UTC)
    - cron: "30 3 * * 5"

permissions:
  contents: read
  id-token: write
  actions: read

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    env:
      PASSED: "0"
      FAILED: "0"
      TOTAL: "0"
      REPORT_AVAILABLE: "false"
      REPORT_SECTION: ""

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 1. Run Tests
      - name: Run Playwright Tests
        id: run_tests
        continue-on-error: true
        shell: bash
        run: |
          set +e
          npx playwright test --config=microlocs/playwright.config.js --workers=1
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code
        env:
          CI: true

      # 2. Move Reports
      - name: Move Reports to Site Folder
        if: always()
        run: |
          mkdir -p microlocs

          if [ -d "playwright-report" ]; then
            rm -rf microlocs/playwright-report
            mv playwright-report microlocs/
            echo "‚úÖ Moved HTML Report"
          fi

          if [ -f "results.json" ]; then
            mv results.json microlocs/
            echo "‚úÖ Moved JSON Results"
          fi

      - name: Detect Report Availability
        if: always()
        shell: bash
        run: |
          if [ -d "microlocs/playwright-report" ] && \
             [ -f "microlocs/playwright-report/index.html" ]; then
            echo "REPORT_AVAILABLE=true" >> "$GITHUB_ENV"
          else
            echo "REPORT_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      # 3. Calculate Stats
      - name: Calculate Test Stats
        if: always()
        run: |
          node -e "
            try {
              const fs = require('fs');
              if (fs.existsSync('./microlocs/results.json')) {
                const r = require('./microlocs/results.json');
                const passed = r.stats.expected + r.stats.flaky;
                const failed = r.stats.unexpected;
                console.log('PASSED=' + passed);
                console.log('FAILED=' + failed);
                console.log('TOTAL=' + (passed + failed));
              } else {
                console.log('PASSED=0');
                console.log('FAILED=Error');
                console.log('TOTAL=0');
              }
            } catch (e) {
              console.log('PASSED=0');
              console.log('FAILED=Crash');
              console.log('TOTAL=0');
            }
          " >> $GITHUB_ENV

      # =========================
      # GOOGLE DRIVE (OAUTH FLOW)
      # =========================

      - name: Zip Playwright Report
        if: always() && env.REPORT_AVAILABLE == 'true'
        run: |
          sudo apt-get update >/dev/null
          sudo apt-get install -y zip >/dev/null
          cd microlocs
          zip -r playwright-report.zip playwright-report

      - name: Upload Report to Google Drive
        if: always() && env.REPORT_AVAILABLE == 'true'
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          REPORT_ZIP: microlocs/playwright-report.zip
          REPORT_NAME_PREFIX: microlocs-report
        run: |
          node scripts/uploadToDrive.js >> $GITHUB_ENV

      - name: Prepare Report Message
        if: always()
        shell: bash
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          {
            echo "REPORT_SECTION<<EOF"

            if [ "${REPORT_AVAILABLE}" = "true" ] && [ -n "${REPORT_LINK:-}" ]; then
              echo "üìÇ DOWNLOAD FULL REPORT:"
              echo "${REPORT_LINK}"
            else
              echo "‚ö†Ô∏è ISSUE SUMMARY:"

              if [ "${{ steps.run_tests.outcome }}" != "success" ]; then
                echo "- Tests failed (exit code: ${{ steps.run_tests.outputs.exit_code }})"
              else
                echo "- Tests step outcome: ${{ steps.run_tests.outcome }}"
              fi

              if [ "${REPORT_AVAILABLE}" != "true" ]; then
                echo "- Report not generated (microlocs/playwright-report missing)"
              else
                echo "- Report generated but Drive upload failed"
              fi

              echo ""
              echo "Run logs: $RUN_URL"
            fi

            echo "EOF"
          } >> "$GITHUB_ENV"

      # 5. Send Email
      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: premium49.web-hosting.com
          server_port: 465
          username: ${{ secrets.REPORT_FROM_MAIL }}
          password: ${{ secrets.REPORT_FROM_PASSWORD }}
          subject: "Microlocs - QA Automation Complete: ${{ env.PASSED }}/${{ env.TOTAL }} Passed"
          body: |
            Microlocs ‚Äì QA Automation Summary
            Execution Status: Completed

            SUMMARY:
            ‚úÖ Passed: ${{ env.PASSED }}
            ‚ùå Failed: ${{ env.FAILED }}

            ${{ env.REPORT_SECTION }}

            üìã Note:
            1. The test suite was executed sequentially to improve stability.
            2. UI animations were disabled during execution to ensure consistent and reliable visual comparisons.
            3. Smoke tests only verify page reachability and basic structure; screenshots from smoke tests do not represent full-page validation.
            4. Full-page screenshots and sanity checks are performed in visual tests.
          to: ${{ secrets.REPORT_TO_MAILS }}
          from: "QA Automation Bot"
